define(["controller/SSLClientController.js","controller/ConnectionController.js","controller/PageController.js","controller/PasswordResetController.js","view/"+$g.theme+"/message.res.js"],function(e,t,n,r,i){var s={},o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=function(){o=$("div#area_id"),u=$("div#area_confirm"),a=$("div#area_password"),f=$("div#area_otp"),l=$("div#area_error"),c=$("input[type=text]#txt_id"),h=$("input[type=password]#txt_password"),p=$("input[type=password]#txt_otp"),d=$("span.help-block#lbl_confirm"),v=$("span.help-block#lbl_error"),m=$("button#btn_login_start"),g=$("button#btn_login"),y=$("button#btn_another"),b=$("button#btn_lost_password"),btnCertCenter=$("button#btn_cert_center"),btnVersion=$(".s_version")},T=function(){log("init loginstart"),t.CancelLogin(),x(),N(),e.SetHostname(),setTimeout(function(){e.RequestVpnInfo(function(e){s.encryptions=e.encryptions,s.auth_method=e.auth_method,s.internal_ip=e.internal_ip,s.use_auth_center=e.use_auth_center,(e.auth_method===1||e.auth_method===3||e.auth_method===5)&&e.encryptions!=""&&(log("no need to request auth_method"),B(),c.focus(),y.hide(),b.show()),e.use_auth_center&&btnCertCenter.show(),log(e.id_label),e.id_label!=null&&(/^\s*$/.test(e.id_label)||$("label[for=txt_id]").text(e.id_label))})},100),c.focus(),n.preload("view/"+$g.theme+"/page/loading.html",function(e){w=e}),n.preload("view/"+$g.theme+"/page/version.html",function(e){E=e}),n.loadNotice(),$g.noTopImage&&$(".s_top_image").addClass("top_fallback"),$g.noNoticeImage&&$(".s_notice_image").addClass("notice_fallback"),n.linkClientDownload()},N=function(){m.on("click",M),y.on("click",_),g.on("click",D),b.on("click",O),c.on("keydown",L),h.on("keydown",A),btnCertCenter.on("click",k),btnVersion.on("click",C)},C=function(){n.openModal("about:blank",240,function(){$(".modal-iframe").remove();var e=$("<div>").html(E).appendTo(".modal");e.find("#lblverTSGSSL").text(TSGSSL.GetRevNum()),e.find("#lblverTSGSSLClient").text(TSGSSLClient.GetRevNum()),$.get("/version.js.txt",function(t){e.find("#lblverWebLogin").text(t.substring(8))}),$("#btnVersionWinClose").on("click",function(){n.closeModal()})})},k=function(t){e.LaunchPrivCertCenter()},L=function(e){e.keyCode==13&&ie_ver<9&&(e.stopPropagation(),e.preventDefault(),m.is(":hidden")?g.click():m.click())},A=function(e){e.keyCode==13&&ie_ver<9&&(e.stopPropagation(),e.preventDefault(),g.click())},O=function(e){n.openModal("pwlost.html",350)},M=function(e){e.stopPropagation(),e.preventDefault(),c.prop("disabled",!0),m.prop("disabled",!0);if(!H(c.val()))return;t.RequestAuthMethod(c.val(),{success:function(e){s=$.extend(s,e),log("auth_method_override: "+JSON.stringify(s)),log("[RequestAuthMethod] success"),B(),e.password_resetable&&b.fadeIn()},failed:function(e,t){c.prop("disabled",!1),t=="Not Found"?($g.showMessageBox("#area_id",i.NoLoginName),c.select().focus()):t=="Internal Server Error"?($g.showMessageBox("#area_id",i.RequireLoginName),c.select().focus()):($g.showMessageBox("#area_id",i.UnknownError+"<br/>"+e+"<br/>"+t),c.select().focus()),m.prop("disabled",!1)}})},_=function(e){e.stopPropagation(),e.preventDefault(),c.val("").prop("disabled",!1).focus(),h.val(""),p.val(""),a.hide(),f.hide(),y.hide(),g.hide(),m.fadeIn().prop("disabled",!1),l.hide()},D=function(e){e.stopPropagation(),e.preventDefault();var r=c.val(),o=h.val(),u=p.val();if(!H(r))return;log("[btnLogin_click] "+r);if(s.force_password_change)n.openModal("pwchange.html?type=expired&login_name="+c.val(),470);else if(s.auth_method==2||s.auth_method==4)t.RequestLogin(s,r,o,P);else{if(o==undefined||o==""){log("password is blank"),$g.showMessageBox("#area_password",i.RequirePassword),h.focus();return}if(s.auth_method==6)if(u==undefined||u==""){log("otp is blank"),$g.showMessageBox("#area_otp",i.RequireOtp),p.focus();return}h.prop("disabled",!0),p.prop("disabled",!0),g.prop("disabled",!0),y.prop("disabled",!0);var a=t.RequestLogin(s,r,o,P,u);t.savedPassword(),t.savedPassword(o),a||(h.prop("disabled",!1),s.auth_method==6&&p.prop("disabled",!1),g.prop("disabled",!1),y.prop("disabled",!1),h.select().focus())}},P={success:function(){log("[RequestLogin_callback] success")},canceled:function(){log("[RequestLogin_callback] canceled"),s.auth_method===2||s.auth_method===4?(m.prop("disabled",!1),c.prop("disabled",!1).select().focus()):(h.prop("disabled",!1),s.auth_method==6&&p.prop("disabled",!1),g.prop("disabled",!1),y.prop("disabled",!1),h.select().focus())},failed:function(e,r){log("[RequestLogin_callback] failed"),log(r),log(e);var i;try{i=JSON.parse(r)}catch(o){e>=8e3&&e<9e3?e==t.AXM.AXM_VPN_SESSION_INIT_FAILED?alert("VPN 연결을 초기화할 수 없습니다. 드라이버가 제대로 설치되지 않았거나, 서비스가 중지되었을 수 있습니다. (8003)"):alert("기타 에러 ("+e+")"):alert("알수 없는 에러 ("+e+")");return}var u=i.authCode_usermsg;i.authCode==24&&i.authCode_debugmsg=="password-expired"&&n.openModal("pwchange.html?type=expired&login_name="+c.val(),470);if(i.authCode==2||i.authCode==25)u=i.authCode_usermsg+" (암호 연속 실패: "+i.authOpt+"회)";s.auth_method===2||s.auth_method===4?(m.prop("disabled",!1),c.prop("disabled",!1).select().focus()):(h.prop("disabled",!1),s.auth_method==6&&p.prop("disabled",!1),g.prop("disabled",!1),y.prop("disabled",!1),h.select().focus()),l.show(),$g.showMessageBox("#area_error",u)},loginSuccess:function(){log("[RequestLogin_callback] loginSuccess"),$(window).on({beforeunload:function(){return"이 페이지를 나가시겠습니까? 인터넷창 종료시 VPN연결이 유지되고, 작업표시줄의 SSLplus 아이콘에서 접속 종료할 수 있습니다."},unload:function(){t.ActivexTrayEnabled()}}),n.html(w),$g.noTopImage&&$(".s_top_image").addClass("top_fallback"),$g.noNoticeImage&&$(".s_notice_image").addClass("notice_fallback")},connCompleted:function(e,t,r,i){function o(e){var t=/[\S]/;return!t.test(e)}log("[RequestLogin_callback] connCompleted"),log("[RequestLogin_callback] ip address: "+e),log("[RequestLogin_callback] others: "+t+", "+r+", "+i);if(s.popup_url){var u=s.popup_url;o(u)||window.open(u)}n.loadStatic("Applist",function(t){t.setIp(e)})},mutexFailed:function(){log("[OnCompleted_RequestLogin] mutexFailed"),s.auth_method===2||s.auth_method===4?(m.prop("disabled",!1),c.prop("disabled",!1).select().focus()):(h.prop("disabled",!1),s.auth_method==6&&p.prop("disabled",!1),g.prop("disabled",!1),y.prop("disabled",!1),h.select().focus()),l.show(),$g.showMessageBox("#area_error",i.MutexFailed)},setAuthMethodFailed:function(){log("[OnCompleted_RequestLogin] setAuthMethodFailed"),s.auth_method===2||s.auth_method===4?(m.prop("disabled",!1),c.prop("disabled",!1).select().focus()):(h.prop("disabled",!1),s.auth_method==6&&p.prop("disabled",!1),g.prop("disabled",!1),y.prop("disabled",!1),h.select().focus()),l.show(),$g.showMessageBox("#area_error","모든 브라우저를 닫고 다시 시도해주세요.")}},H=function(e){return e==undefined||e==""?($g.showMessageBox("#area_id",i.RequireLoginName),m.prop("disabled",!1),c.prop("disabled",!1).focus(),!1):!0},B=function(){if(s.auth_method===1)a.fadeIn(),m.hide(),g.fadeIn(),y.fadeIn(),h.focus();else if(s.auth_method===2||s.auth_method===4){var e=t.RequestLogin(s,c.val(),h.val(),P);e||(m.prop("disabled",!1),c.prop("disabled",!1).select().focus())}else s.auth_method===3||s.auth_method===5?(a.fadeIn(),m.hide(),g.fadeIn(),y.fadeIn(),h.focus()):s.auth_method===6&&(a.fadeIn(),f.fadeIn(),m.hide(),g.fadeIn(),y.fadeIn(),h.focus())};return{init:T}})